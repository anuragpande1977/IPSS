<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IPSS Questionnaire – Email Gate → Score</title>
  <style>
    :root {
      --bg: #f9fafb;
      --card: #ffffff;
      --ink: #1f2937;
      --muted: #6b7280;
      --accent: #2563eb;
      --ok: #16a34a;
      --warn: #ca8a04;
      --bad: #dc2626;
      --border: #e5e7eb;
    }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color: var(--ink); }
    .wrap { max-width: 900px; margin: 0 auto; padding: 24px; }
    .card { background: var(--card); border-radius: 12px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid var(--border); }
    h1 { font-size: 28px; font-weight: 700; margin: 0 0 8px; }
    h2 { font-size: 20px; margin: 20px 0 10px; font-weight: 600; }
    p { color: var(--muted); line-height: 1.55; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; background:#eef2ff; color:#3730a3; margin: 0 0 12px; }
    .options { display:grid; gap:8px; }
    label.opt { display:flex; align-items:center; gap:10px; background:#f3f4f6; border:1px solid #d1d5db; padding:10px 12px; border-radius:8px; cursor:pointer; transition: background .2s; }
    label.opt:hover { background:#e5e7eb; }
    input[type="radio"]{ accent-color: var(--accent); }
    input[type="email"] { padding:12px; border-radius:8px; border:1px solid #d1d5db; width:100%; background:#fff; color:var(--ink); }
    .row { display:grid; gap:12px; }
    .cta { display:flex; gap:10px; margin-top:16px; flex-wrap:wrap; }
    .btn { background: var(--accent); color: #fff; border: none; padding: 12px 18px; border-radius: 8px; font-weight: 600; cursor:pointer; }
    .btn.alt { background:#f3f4f6; color:var(--ink); border:1px solid #d1d5db; }
    .hide { display:none; }
    .result { margin-top: 18px; padding: 16px; border-radius: 8px; background: #f9fafb; border: 1px dashed #d1d5db; }
    .badge { font-weight: 700; padding: 4px 10px; border-radius: 999px; font-size: 14px; }
    .mild { background:#dcfce7; color:var(--ok); }
    .moderate { background:#fef9c3; color:var(--warn); }
    .severe { background:#fee2e2; color:var(--bad); }
    .note { font-size:12px; color:var(--muted); }
    .footer { margin-top:24px; font-size:12px; color:var(--muted); }
  </style>
</head>
<body>
  <!-- Hidden iframe ensures the form posts without leaving the page -->
  <iframe name="hidden_iframe" style="display:none;"></iframe>

  <div class="wrap">
    <div class="card">
      <h1>IPSS Symptom Check</h1>
      <span class="pill">Educational • 2–3 minutes</span>
      <p>Enter your email to continue. You’ll see your personal IPSS score (mild / moderate / severe) on the next step. This is educational only and not medical advice.</p>

      <!-- Step 1 — Email Gate -->
      <div id="gate">
        <h2>Step 1 — Get started</h2>

        <!-- IMPORTANT: replace YOUR_EXEC_URL with your Apps Script Web App /exec URL -->
        <form id="gateForm"
              action="https://script.google.com/macros/s/AKfycbybQNdlEGIYavav9RQvVpkzZCA-FlG72sRjLHKWWlnPZm7MXTMbR4RgTyL_78IEL1tGwA/exec"
              method="post"
              target="hidden_iframe"
              onsubmit="return onGateSubmit(event)">
          <div class="row">
            <!-- name="email" is REQUIRED so Apps Script receives e.parameter.email -->
            <input type="email" id="email" name="email"
                   placeholder="Email (required to continue)" required />
          </div>

          <!-- Optional context fields you can log in your sheet -->
          <input type="hidden" name="source" value="github">
          <input type="hidden" name="ua"  id="ua_field">
          <input type="hidden" name="ref" id="ref_field">

          <label style="display:flex; gap:8px; align-items:flex-start; margin-top:10px; font-size:12px; color:var(--muted)">
            <input type="checkbox" id="consent" required/> I agree to receive my result and educational messages about urinary health (opt out anytime).
          </label>

          <div class="cta">
            <button type="submit" class="btn">Continue</button>
          </div>
          <p class="note">Privacy: Only your email is submitted. No other data is collected.</p>
        </form>
      </div>

      <!-- Step 2 — IPSS Form (local scoring only; nothing is sent) -->
      <div id="ipssSection" class="hide">
        <h2>Step 2 — IPSS Questionnaire</h2>
        <form id="ipssForm">
          <div id="ipssQuestions"></div>

          <h2>Quality of Life (Bother) Question</h2>
          <fieldset>
            <div class="options">
              <label class="opt"><input type="radio" name="qol" value="0" required/> Delighted (0)</label>
              <label class="opt"><input type="radio" name="qol" value="1"/> Pleased (1)</label>
              <label class="opt"><input type="radio" name="qol" value="2"/> Mostly satisfied (2)</label>
              <label class="opt"><input type="radio" name="qol" value="3"/> Mixed (3)</label>
              <label class="opt"><input type="radio" name="qol" value="4"/> Mostly dissatisfied (4)</label>
              <label class="opt"><input type="radio" name="qol" value="5"/> Unhappy (5)</label>
              <label class="opt"><input type="radio" name="qol" value="6"/> Terrible (6)</label>
            </div>
          </fieldset>

          <div class="cta">
            <button type="submit" class="btn">See my score</button>
          </div>
        </form>

        <div id="result" class="result hide"></div>

        <div class="footer">
          <p><strong>Disclaimer:</strong> This tool is for education only and does not diagnose, treat, or replace professional medical advice.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Build IPSS questions dynamically
    const ipssItems = [
      {key:'q1', text:'Incomplete emptying: How often have you had a sensation of not emptying your bladder completely after you finished urinating?'},
      {key:'q2', text:'Frequency: How often have you had to urinate again less than two hours after you last finished urinating?'},
      {key:'q3', text:'Intermittency: How often have you found you stopped and started again several times when you urinated?'},
      {key:'q4', text:'Urgency: How often have you found it difficult to postpone urination?'},
      {key:'q5', text:'Weak stream: How often have you had a weak urinary stream?'},
      {key:'q6', text:'Straining: How often have you had to push or strain to begin urination?'},
      {key:'q7', text:'Nocturia: How many times do you typically get up at night to urinate? (0 to 5+ times)'}
    ];
    const generic = [
      {v:0,l:'Never (0)'},{v:1,l:'Less than 1 in 5 times (1)'},{v:2,l:'Less than half the time (2)'},
      {v:3,l:'About half the time (3)'},{v:4,l:'More than half the time (4)'},{v:5,l:'Almost always (5)'}
    ];
    const nocturia = [
      {v:0,l:'0 times (0)'},{v:1,l:'1 time (1)'},{v:2,l:'2 times (2)'},
      {v:3,l:'3 times (3)'},{v:4,l:'4 times (4)'},{v:5,l:'5 or more times (5)'}
    ];
    const qWrap = document.getElementById('ipssQuestions');
    ipssItems.forEach((it, idx)=>{
      const fs = document.createElement('fieldset');
      const q = document.createElement('div');
      q.className = 'q';
      q.textContent = (idx+1)+') '+it.text;
      fs.appendChild(q);
      const opts = document.createElement('div');
      opts.className='options';
      const set = (it.key==='q7' ? nocturia : generic);
      set.forEach(c=>{
        const lab = document.createElement('label');
        lab.className = 'opt';
        lab.innerHTML = `<input type="radio" name="${it.key}" value="${c.v}" required/> ${c.l}`;
        opts.appendChild(lab);
      });
      fs.appendChild(opts);
      qWrap.appendChild(fs);
    });

    // Gate handler: validate, set hidden fields, allow native POST, then reveal step 2
    function onGateSubmit(e){
      const email = document.getElementById('email').value.trim();
      const consent = document.getElementById('consent').checked;
      if(!email || !consent){
        alert('Please enter your email and tick consent to continue.');
        return false; // block submit
      }
      // populate hidden metadata right before submit
      const uaEl  = document.getElementById('ua_field');
      const refEl = document.getElementById('ref_field');
      if (uaEl)  uaEl.value  = navigator.userAgent || '';
      if (refEl) refEl.value = document.referrer || location.href;

      // let the browser POST to Apps Script (hidden iframe), then reveal Step 2
      setTimeout(()=>{
        document.getElementById('gate').classList.add('hide');
        document.getElementById('ipssSection').classList.remove('hide');
      }, 300);
      return true; // allow submit
    }

    // Local score calculation (no network calls)
    document.getElementById('ipssForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      let total = 0;
      for(let i=1;i<=7;i++){
        const sel = document.querySelector('input[name="q'+i+'"]:checked');
        if(!sel){ alert('Please answer question '+i); return; }
        total += parseInt(sel.value, 10);
      }
      const qol = parseInt((document.querySelector('input[name="qol"]:checked')||{value:NaN}).value,10);
      const cat = total<=7 ? 'Mild' : (total<=19 ? 'Moderate' : 'Severe');
      const badgeClass = total<=7 ? 'mild' : (total<=19 ? 'moderate' : 'severe');
      const guidance = total<=7 ? 'Your symptoms are in the mild range.'
                                : (total<=19 ? 'Your symptoms are in the moderate range.'
                                             : 'Your symptoms are in the severe range.');

      const res = document.getElementById('result');
      res.classList.remove('hide');
      res.innerHTML = `
        <div><span class="pill">Your IPSS</span></div>
        <h2>Total: <span class="badge ${badgeClass}">${total} / 35 • ${cat}</span></h2>
        <p>Quality-of-life (bother): <strong>${isNaN(qol)?'—':qol+' / 6'}</strong></p>
        <p>${guidance} This is for education only and not medical advice.</p>
      `;
    });
  </script>
</body>
</html>
